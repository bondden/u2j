{"version":3,"sources":["importer.es7.js"],"names":[],"mappings":"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","file":"importer.es7.js","sourcesContent":["/**\n * Created by Denis Bondarenko <bond.den@gmail.com> on 16.05.2015.\n */\n\n/**\n * Connects to OrientDb server.\n * Creates DB schema or adds classes to existent schema from parsedData.\n */\n'use strict';\n\nimport * as UtilLib from '../lib/util'\n\nvar\n\tfs=require('fs'),\n\tL\t= UtilLib.Util.log,\n\tclc=require('cli-color'),\n\t___=console.log,\n\tt=false,\n\tE=function(n=0,msg=false,e=false,rj=false,thr=false){\n\n\t\tif(!msg){\n\t\t\tmsg=`: ${msg}\\n`;\n\t\t}else{\n\t\t\tmsg='\\n';\n\t\t}\n\t\tL(`Error Importer#${n}${msg}`);\n\t\tL(e,'er');\n\n\t\tif(t)clearInterval(t);\n\n\t\tif(e){\n\t\t\tL(e,'er');\n\t\t\tif(rj){\n\t\t\t\trj(e);\n\t\t\t}\n\t\t\tif(thr){\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\n\t}\n;\n\nexport class Importer {\n\n\tconstructor(db,cnf){\n\t\tthis.db=db;\n\t\tthis.cnf=cnf;\n\t}\n\n\tcomposeClass(classData){\n\n\t\tif(!classData.hasOwnProperty('name')||!classData.name){\n\t\t\tthrow new Error('Error Importer#6: Incorrect class '+classData);\n\t\t}\n\n\t\tlet cd={\n\t\t\t\"name\":classData.name,\n\t\t\t\"parent\":false,\n\t\t\t\"queryString\":''\n\t\t};\n\n\t\tlet c={\n\t\t\t\"name\"     :classData.name,\n\t\t\t\"extends\"  :'',\n\t\t\t\"abstract\" :''\n\t\t};\n\n\t\tif(classData.hasOwnProperty('superClass')&&classData.superClass){\n\t\t\tc.extends=' extends '+classData.superClass;\n\t\t\tcd.parent=classData.superClass;\n\t\t}\n\n\t\tif(classData.hasOwnProperty('abstract')&&classData.abstract){\n\t\t\tc.abstract=' ABSTRACT';\n\t\t}\n\n\t\tcd.queryString=`create class ${c.name}${c.extends}${c.abstract}\\n`;\n\n\t\tclassData.properties.forEach(function(p){\n\t\t\tcd.queryString+=`create property ${c.name}.${p.name} ${p.type}\\n`;\n\t\t});\n\n\t\treturn cd;\n\n\t}\n\n\tcomposeQuery(data){\n\n\t\tlet q='';\n\t\tif(data.classes.length===0){\n\t\t\treturn q;\n\t\t}\n\n\t\tvar holder=this;\n\n\t\tlet classes=[];\n\t\tdata.classes.forEach(function(c){\n\t\t\tclasses.push(holder.composeClass(c));\n\t\t});\n\n\t\t//sort classes to set superClass to the top\n\t\tfor(let i=0,l=classes.length;i<l;i++){\n\t\t\tif(!classes[i].parent)continue;\n\t\t\tfor(let j=0;j<l;j++){\n\t\t\t\tif(classes[j].name===classes[i].parent && j>i){\n\t\t\t\t\tlet t=JSON.parse(JSON.stringify(classes[j]));\n\t\t\t\t\tclasses[j]=JSON.parse(JSON.stringify(classes[i]));\n\t\t\t\t\tclasses[i]=t;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//\n\n\t\tclasses.forEach(function(c,i){\n\t\t\tq+=c.queryString;\n\t\t});\n\n\t\treturn q;\n\n\t}\n\n\trunQuerySync(q){\n\t\tvar holder=this;\n\n\t\treturn new Promise(function(rs,rj) {\n\n\t\t\tlet cycle=async function(qs){\n\t\t\t\tvar r = null;\n\t\t\t\ttry{\n\t\t\t\t\tfor(let i=0,l=qs.length;i<l;i++){\n\n\t\t\t\t\t\tt=setInterval(function(){\n\t\t\t\t\t\t\tprocess.stdout.write(clc.blueBright('.'));\n\t\t\t\t\t\t},25);\n\n\t\t\t\t\t\t//___(clc.yellow(qs[i]));\n\t\t\t\t\t\tr = await holder.db.exec(qs[i]);\n\t\t\t\t\t\t//___(clc.magentaBright(JSON.stringify(r)));\n\t\t\t\t\t\tclearInterval(t);\n\n\t\t\t\t\t}\n\t\t\t\t}catch(e){\n\t\t\t\t\tE(6,'Query error',e);\n\t\t\t\t}\n\t\t\t\treturn r;\n\t\t\t};\n\n\t\t\tlet qs = q.trim().split('\\n');\n\n\t\t\tcycle(qs).catch(function(e){\n\n\t\t\t\tE(4,'Query error',e,rj);\n\n\t\t\t}).then(function(r){\n\n\t\t\t\trs(`${qs.length} records have been inserted`);\n\n\t\t\t});\n\n\t\t});\n\n\t}\n\n\trunQuery(q){\n\t\tvar holder=this;\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\tholder.db.exec(q,{class: \"s\"}).then(function(r){\n\n\t\t\t\trs(r);\n\n\t\t\t}).catch(function(e){\n\n\t\t\t\tE(3,'Query execution',e,rj);\n\n\t\t\t});\n\n\t\t});\n\t}\n\n\t/**\n\t *\n\t * @param data  : parsedData format\n\t * @param connConfig : (cnf.json).orient format\n\t * @returns {Promise}\n\t */\n\timportParsedData(data){\n\n\t\tvar holder=this;\n\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\tif(!data||!data.classes){\n\t\t\t\tE(1,\n\t\t\t\t\t'the data for import is incorrect',\n\t\t\t\t\tnew Error('Error Importer#1: the data for import is incorrect'),\n\t\t\t\t\trj\n\t\t\t\t);\n\t\t\t}\n\n\t\t\ttry{\n\n\t\t\t\tvar q=holder.composeQuery(data);\n\n\t\t\t}catch(e){\n\t\t\t\tE(7,'Query composition',e,rj);\n\t\t\t\treturn e;\n\t\t\t}\n\n\t\t\tlet promises=[\n\t\t\t\tnew Promise(function(rs,rj){\n\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\trj(new Error('Error Importer#5: Timeout '+holder.cnf.timeout+' ms exceeded'));\n\t\t\t\t\t},holder.cnf.timeout);\n\t\t\t\t}),\n\t\t\t\tholder.runQuery(q)\n\t\t\t];\n\n\t\t\tPromise.race(promises).then(function(r){\n\t\t\t\tif(t)clearInterval(t);\n\t\t\t\trs(r);\n\t\t\t}).catch(function(e){\n\t\t\t\tE(2,'Database communication',e,rj);\n\t\t\t});\n\n\t\t});\n\t}\n\n}\n"],"sourceRoot":"/source/"}