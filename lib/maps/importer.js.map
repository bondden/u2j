{"version":3,"sources":["importer.es7.js"],"names":[],"mappings":"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","file":"importer.es7.js","sourcesContent":["/**\n * Created by Denis Bondarenko <bond.den@gmail.com> on 16.05.2015.\n */\n\n/**\n * Connects to OrientDb server.\n * Creates DB schema or adds classes to existent schema from parsedData.\n */\n'use strict';\n\nimport * as UtilLib from '../lib/util'\n\nvar\n\tfs=require('fs'),\n\tL\t= UtilLib.Util.log,\n\tclc=require('cli-color')\n;\n\nexport class Importer {\n\n\tconstructor(db,cnf){\n\t\tthis.db=db;\n\t\tthis.cnf=cnf;\n\t}\n\n\tcomposeClass(classData){\n\n\t\tif(!classData.hasOwnProperty('name')||!classData.name){\n\t\t\tthrow new Error('Error Importer#4: Incorrect class '+classData);\n\t\t}\n\n\t\tlet cd={\n\t\t\t\"name\":classData.name,\n\t\t\t\"parent\":false,\n\t\t\t\"queryString\":''\n\t\t};\n\n\t\tlet c={\n\t\t\t\"name\"     :classData.name,\n\t\t\t\"extends\"  :'',\n\t\t\t\"abstract\" :''\n\t\t};\n\n\t\tif(classData.hasOwnProperty('superClass')&&classData.superClass){\n\t\t\tc.extends=' extends '+classData.superClass;\n\t\t\tcd.parent=classData.superClass;\n\t\t}\n\n\t\tif(classData.hasOwnProperty('abstract')&&classData.abstract){\n\t\t\tc.abstract=' ABSTRACT';\n\t\t}\n\n\t\tcd.queryString=`create class ${c.name}${c.extends}${c.abstract};\\n`;\n\n\t\tclassData.properties.forEach(function(p){\n\t\t\tcd.queryString+=`create property ${c.name}.${p.name} ${p.type};\\n`;\n\t\t});\n\n\t\treturn cd;\n\n\t}\n\n\tcomposeQuery(data){\n\n\t\tlet q='';\n\t\tif(data.classes.length===0){\n\t\t\treturn q;\n\t\t}\n\n\t\tvar holder=this;\n\n\t\tlet classes=[];\n\t\tdata.classes.forEach(function(c){\n\t\t\tclasses.push(holder.composeClass(c));\n\t\t});\n\n\t\t//sort classes to set superClass to the top\n\t\tfor(let i=0,l=classes.length;i<l;i++){\n\t\t\tif(!classes[i].parent)continue;\n\t\t\tfor(let j=0;j<l;j++){\n\t\t\t\tif(classes[j].name===classes[i].parent && j>i){\n\t\t\t\t\tlet t=JSON.parse(JSON.stringify(classes[j]));\n\t\t\t\t\tclasses[j]=JSON.parse(JSON.stringify(classes[i]));\n\t\t\t\t\tclasses[i]=t;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//\n\n\t\tclasses.forEach(function(c,i){\n\t\t\tq+=c.queryString;\n\t\t});\n\n\t\t//q=`create class Tmp extends V;`;\n\t\t//q=`begin;${q}commit retry 5;`;\n\n\t\tq='begin;create class Tmp1 extends V;create class Tmp2 extends V;commit retry 10;';\n\t\tq='begin\\ncreate class Tmp1 extends V\\ncreate class Tmp2 extends V\\ncommit retry 10';\n\n\t\treturn q;\n\n\t}\n\n\tasync runSubQuery(){\n\n\t}\n\n\trunQuery(q){\n\t\tvar holder=this;\n\t\treturn new Promise(function(rs,rj){\n\n\n\n\t\t\tholder.db.exec(q).then(function(r){\n\n\t\t\t\trs(r);\n\n\t\t\t}).catch(function(e){\n\n\t\t\t\tL('Error Importer#3','er');\n\t\t\t\tL(e);\n\t\t\t\trj(e);\n\n\t\t\t});\n\n\t\t});\n\t}\n\n\t/**\n\t *\n\t * @param data  : parsedData format\n\t * @param connConfig : (cnf.json).orient format\n\t * @returns {Promise}\n\t */\n\timportParsedData(data){\n\n\t\tvar holder=this;\n\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\tif(!data||!data.classes){\n\t\t\t\trj(new Error('Error Importer#1: the data for import is incorrect'));\n\t\t\t}\n\n\t\t\ttry{\n\n\t\t\t\tvar q=holder.composeQuery(data);\n\n\t\t\t}catch(e){\n\t\t\t\trj(e);\n\t\t\t\treturn e;\n\t\t\t}\n\n\t\t\tholder.runQuery(q).then(function(r){\n\t\t\t\trs(r);\n\t\t\t}).catch(function(e){\n\t\t\t\tL('Error Importer#2','er');\n\t\t\t\tL(e);\n\t\t\t\trj(new Error('Error Importer#2: database communication'));\n\t\t\t});\n\n\t\t});\n\t}\n\n}\n"],"sourceRoot":"/source/"}