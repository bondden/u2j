{"version":3,"sources":["importer.es7.js"],"names":[],"mappings":"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","file":"importer.es7.js","sourcesContent":["/**\n * Created by Denis Bondarenko <bond.den@gmail.com> on 16.05.2015.\n */\n\n/**\n * Connects to OrientDb server.\n * Creates DB schema or adds classes to existent schema from parsedData.\n */\n'use strict';\n\nimport * as UtilLib from '../lib/util'\n\nvar\n\tfs=require('fs'),\n\tL\t= UtilLib.Util.log,\n\tclc=require('cli-color'),\n\t___=console.log,\n\t__p=process.stdout.write,\n\tt=false,\n\tE=function(n=0,msg=false,e=false,rj=false,thr=false){\n\n\t\tif(!msg){\n\t\t\tmsg=`: ${msg}\\n`;\n\t\t}else{\n\t\t\tmsg='\\n';\n\t\t}\n\t\tL(`Error Importer#${n}${msg}`);\n\t\tL(e,'er');\n\n\t\tif(t)clearInterval(t);\n\n\t\tif(e){\n\t\t\tL(e,'er');\n\t\t\tif(rj){\n\t\t\t\trj(e);\n\t\t\t}\n\t\t\tif(thr){\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\n\t}\n;\n\n//todo: transaction style\nexport class Importer {\n\n\tconstructor(db,cnf){\n\t\tthis.db=db;\n\t\tthis.cnf=cnf;\n\t}\n\n\tgeneralizationSort(arr,parent='superClass',name='name'){\n\n\t\tfunction branch(o,a){\n\t\t\tfor(let i=0,l=a.length;i<l;i++){\n\t\t\t\tif(a[i][parent]===o[name]){\n\t\t\t\t\ta[i].level=o.level+1;\n\t\t\t\t\tbranch(a[i],a);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tlet a=JSON.parse(JSON.stringify(arr));\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\tfor(let i=0,l=a.length;i<l;i++){\n\n\t\t\t\t//level 0\n\t\t\t\ta[i].level=a[i][parent]?1:0;\n\n\t\t\t\tif(a[i].level){\n\t\t\t\t\ta[i].hasParentInTheArr=a.find(function(el,i,arrPtr){\n\t\t\t\t\t\treturn el[name]===a[i][parent];\n\t\t\t\t\t});\n\t\t\t\t\tif(!a[i].hasParentInTheArr){\n\t\t\t\t\t\ta[i].level=0;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//level>0\n\t\t\t\tif(a[i].level){\n\n\t\t\t\t}\n\n\t\t\t\tbranch(a[i],a);\n\n\t\t\t}\n\n\t\t\tlet tops=a.sort(function(x,y){\n\t\t\t\treturn x.level-y.level;\n\t\t\t}).map(function(o){\n\t\t\t\treturn {\n\t\t\t\t\t[name]:o[name],\n\t\t\t\t\t[parent]:o[parent],\n\t\t\t\t\t\"l\":o.level\n\t\t\t\t};\n\t\t\t});\n\n\n\t\t\trs(tops);\n\t\t});\n\n\t}\n\n\tcomposeClass(classData){\n\n\t\tif(!classData.hasOwnProperty('name')||!classData.name){\n\t\t\tthrow new Error('Error Importer#6: Incorrect class '+classData);\n\t\t}\n\n\t\tlet cd={\n\t\t\t\"name\":classData.name,\n\t\t\t\"parent\":false,\n\t\t\t\"queryString\":''\n\t\t};\n\n\t\tlet c={\n\t\t\t\"name\"     :classData.name,\n\t\t\t\"extends\"  :'',\n\t\t\t\"abstract\" :''\n\t\t};\n\n\t\tif(classData.hasOwnProperty('superClass')&&classData.superClass){\n\t\t\tc.extends=' extends '+classData.superClass;\n\t\t\tcd.parent=classData.superClass;\n\t\t}\n\n\t\tif(classData.hasOwnProperty('abstract')&&classData.abstract){\n\t\t\tc.abstract=' ABSTRACT';\n\t\t}\n\n\t\tcd.queryString+=`create class ${c.name}${c.extends}${c.abstract}\\n`;\n\n\t\tclassData.properties.forEach(function(p){\n\t\t\tcd.queryString+=`create property ${c.name}.${p.name} ${p.type}\\n`;\n\t\t});\n\n\t\treturn cd;\n\n\t}\n\n\tcleanDb(classes){\n\t\tvar holder=this;\n\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\tlet q='';\n\t\t\tlet ce=[];\n\n\t\t\tholder.db.class.list().then(function(existentClasses){\n\n\t\t\t\texistentClasses=existentClasses.map(function(v){\n\t\t\t\t\treturn {\n\t\t\t\t\t\t\"name\":v.name,\n\t\t\t\t\t\t\"superClass\":v.superClass\n\t\t\t\t\t};\n\t\t\t\t});\n\n\t\t\t\texistentClasses.forEach(function(c){\n\t\t\t\t\tlet isSys=holder.cnf.modules.importer.systemClasses.find(function(el,i,a){\n\t\t\t\t\t\treturn el===c.name;\n\t\t\t\t\t});\n\t\t\t\t\tif(isSys)return;\n\t\t\t\t\tce.push(c);\n\t\t\t\t});\n\n\t\t\t\t//___(clc.magenta('\\nbefore sort'));\n\t\t\t\t//___(ce);\n\t\t\t\t//___('\\n');\n\n\t\t\t\tholder.generalizationSort(ce).catch(function(e){\n\t\t\t\t\tE(11,'sorting',e,rj);\n\t\t\t\t}).then(function(a){\n\n\t\t\t\t\t//___(clc.magenta('\\nafter sort'));\n\t\t\t\t\t//___(a);\n\t\t\t\t\t//___('\\n');\n\n\t\t\t\t\tfor(let i=a.length-1;i>=0;i--){\n\t\t\t\t\t\tlet nm=a[i].name;\n\t\t\t\t\t\tq+=`truncate class ${nm} UNSAFE\\n`;\n\t\t\t\t\t\tq+=`drop class ${nm}\\n`;\n\t\t\t\t\t}\n\n\t\t\t\t\t//L(clc.yellow('q:\\n'+q)+'\\n');\n\n\t\t\t\t\trs(q);\n\n\t\t\t\t});\n\n\t\t\t}).catch(function(e){\n\t\t\t\tE(10,'Listing classes',e,rj);\n\t\t\t});\n\n\t\t});\n\n\t}\n\n\tcomposeQuery(data){\n\n\t\tvar holder=this;\n\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\tlet q='';\n\t\t\t//it not nessessary to have classes to import, if we want just to clean DB\n\t\t\t//if(data.classes.length===0){\n\t\t\t//\tL('No classes to import');\n\t\t\t//\trs(q);\n\t\t\t//\treturn q;\n\t\t\t//}\n\n\t\t\tlet classes=[];\n\t\t\tdata.classes.forEach(function(c){\n\t\t\t\tclasses.push(holder.composeClass(c));\n\t\t\t});\n\n\t\t\t//sort classes to set superClass to the top\n\t\t\tfor(let i=0,l=classes.length;i<l;i++){\n\t\t\t\tif(!classes[i].parent)continue;\n\t\t\t\tfor(let j=0;j<l;j++){\n\t\t\t\t\tif(classes[j].name===classes[i].parent && j>i){\n\t\t\t\t\t\tlet t=JSON.parse(JSON.stringify(classes[j]));\n\t\t\t\t\t\tclasses[j]=JSON.parse(JSON.stringify(classes[i]));\n\t\t\t\t\t\tclasses[i]=t;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t//\n\n\t\t\tholder.cleanDb(classes).then(function(dropQuery){\n\n\t\t\t\tq+=dropQuery;\n\n\t\t\t\tclasses.forEach(function(c,i){\n\t\t\t\t\tq+=c.queryString;\n\t\t\t\t});\n\n\t\t\t\t//Schema changes are not transactional\n\t\t\t\t//q=`begin\\n${q}\\ncommit`;\n\t\t\t\trs(q);\n\n\t\t\t}).catch(function(e){\n\t\t\t\tE(11,'Composing query',e,rj);\n\t\t\t});\n\n\t\t});\n\n\t}\n\n\trunQuery(q){\n\t\tvar holder=this;\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\t//rs('STOPPED');\n\t\t\t//return('STOPPED');\n\n\t\t\tholder.db.exec(q,{\"class\": \"s\"}).then(function(r){\n\t\t\t\trs(r);\n\t\t\t}).catch(function(e){\n\t\t\t\tE(3,'Query execution',e,rj);\n\t\t\t});\n\n\t\t});\n\t}\n\n\t/**\n\t *\n\t * @param data  : parsedData format\n\t * connConfig : (cnf.json).orient format\n\t * @returns {Promise}\n\t */\n\timportParsedData(data){\n\n\t\tvar holder=this;\n\n\t\treturn new Promise(function(rs,rj){\n\n\t\t\t//simple input data check\n\t\t\tif(!data||!data.classes){\n\t\t\t\tlet msg='the data for import is incorrect';\n\t\t\t\tE(1,msg,new Error(msg),rj);\n\t\t\t}\n\n\t\t\t////choose a method\n\t\t\t//var runMethod=function(q=''){\n\t\t\t//\treturn new Promise(function(rs,rj){\n\t\t\t//\t\tlet msg='No supported import method specified in config';\n\t\t\t//\t\tE(9,msg,new Error(msg),rj);\n\t\t\t//\t});\n\t\t\t//};\n\t\t\t//\n\t\t\t//switch(holder.cnf.modules.importer.method){\n\t\t\t//\tcase 'rewrite':\n\t\t\t//\t\trunMethod=holder.runQuery;\n\t\t\t//\t\tbreak;\n\t\t\t//\tdefault:\n\t\t\t//}\n\n\t\t\t//compose query and run\n\t\t\tholder.composeQuery(data).catch(function(eq){\n\t\t\t\tE(7,'Query composition',eq,rj);\n\t\t\t}).then(function(q){\n\n\t\t\t\t//limit execution time\n\t\t\t\tlet promises=[\n\t\t\t\t\tnew Promise(function(rs,rj){\n\t\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\t\trj(new Error('Error Importer#5: Timeout '+holder.cnf.timeout+' ms exceeded'));\n\t\t\t\t\t\t},holder.cnf.timeout);\n\t\t\t\t\t}),\n\t\t\t\t\tholder.runQuery(q)\n\t\t\t\t];\n\n\t\t\t\t//get result\n\t\t\t\tPromise.race(promises).catch(function(e){\n\t\t\t\t\tE(2,'Database communication',e,rj);\n\t\t\t\t}).then(function(r){\n\t\t\t\t\tif(t)clearInterval(t);\n\t\t\t\t\trs(r);\n\t\t\t\t});\n\n\t\t\t});\n\n\t\t});\n\t}\n\n}\n"],"sourceRoot":"/source/"}